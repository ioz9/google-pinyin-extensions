-- dump : debug, return human readable string of object 'o'
function dump (o, level)
  return dump_r (o, level or 3)
end

function dump_r (o, level)
  local s = ""
  if type(o) == "table" and level ~= 0 then
    s = s .. "{"
    for key, value in pairs(o) do
      s = s .. key .. " = "
      s = s .. dump_r (value, level - 1) .. ", "
    end
    s = s .. "}"
  else
    if type(o) == "function" then
      s = s .. "#function"
    else
      s = s .. (o or "#nil")
    end
  end
  return s
end

debug = nil

function FSM (t)
  local fsm = {}
  for _,v in ipairs(t) do
    local old, event, new, action = v[1], v[2], v[3], v[4]
    if fsm[old] == nil then
      fsm[old] = {}
      -- blame google, setmetatable is NOT usable
      --setmetatable(fsm[old], {__index = function (o, k)
      --  return rawget(o, k) or o[-1]
      --end})
    end
    fsm[old][event] = {new = new, action = action}
  end
  return fsm
end

fsm_hr = FSM {
{ 0, 'a', 0, "あ" },
{ 0, 'b', 1, nil },
{ 0, 'c', 3, nil },
{ 0, 'd', 6, nil },
{ 0, 'e', 0, "え" },
{ 0, 'f', 10, nil },
{ 0, 'g', 13, nil },
{ 0, 'h', 16, nil },
{ 0, 'i', 0, "い" },
{ 0, 'j', 18, nil },
{ 0, 'k', 20, nil },
{ 0, 'l', 23, nil },
{ 0, 'm', 29, nil },
{ 0, 'n', 31, nil },
{ 0, 'o', 0, "お" },
{ 0, 'p', 33, nil },
{ 0, 'q', 35, nil },
{ 0, 'r', 38, nil },
{ 0, 's', 40, nil },
{ 0, 't', 44, nil },
{ 0, 'u', 0, "う" },
{ 0, 'v', 49, nil },
{ 0, 'w', 51, nil },
{ 0, 'x', 53, nil },
{ 0, 'y', 58, nil },
{ 0, 'z', 59, nil },
{ 1, 'a', 0, "ば" },
{ 1, 'e', 0, "べ" },
{ 1, 'i', 0, "び" },
{ 1, 'o', 0, "ぼ" },
{ 1, 'u', 0, "ぶ" },
{ 1, 'y', 2, nil },
{ 1, 'b', 1, "っ" },
{ 3, 'a', 0, "か" },
{ 3, 'e', 0, "せ" },
{ 3, 'h', 4, nil },
{ 3, 'i', 0, "し" },
{ 3, 'o', 0, "こ" },
{ 3, 'u', 0, "く" },
{ 3, 'y', 5, nil },
{ 3, 'c', 3, "っ" },
{ 6, 'a', 0, "だ" },
{ 6, 'e', 0, "で" },
{ 6, 'h', 7, nil },
{ 6, 'i', 0, "ぢ" },
{ 6, 'o', 0, "ど" },
{ 6, 'u', 0, "づ" },
{ 6, 'w', 8, nil },
{ 6, 'y', 9, nil },
{ 6, 'd', 6, "っ" },
{ 10, 'a', 0, "ふぁ" },
{ 10, 'e', 0, "ふぇ" },
{ 10, 'i', 0, "ふぃ" },
{ 10, 'o', 0, "ふぉ" },
{ 10, 'u', 0, "ふ" },
{ 10, 'w', 11, nil },
{ 10, 'y', 12, nil },
{ 10, 'f', 10, "っ" },
{ 13, 'a', 0, "が" },
{ 13, 'e', 0, "げ" },
{ 13, 'i', 0, "ぎ" },
{ 13, 'o', 0, "ご" },
{ 13, 'u', 0, "ぐ" },
{ 13, 'w', 14, nil },
{ 13, 'y', 15, nil },
{ 13, 'g', 13, "っ" },
{ 16, 'a', 0, "は" },
{ 16, 'e', 0, "へ" },
{ 16, 'i', 0, "ひ" },
{ 16, 'o', 0, "ほ" },
{ 16, 'u', 0, "ふ" },
{ 16, 'y', 17, nil },
{ 16, 'h', 16, "っ" },
{ 18, 'a', 0, "じゃ" },
{ 18, 'e', 0, "じぇ" },
{ 18, 'i', 0, "じ" },
{ 18, 'o', 0, "じょ" },
{ 18, 'u', 0, "じゅ" },
{ 18, 'y', 19, nil },
{ 18, 'j', 18, "っ" },
{ 20, 'a', 0, "か" },
{ 20, 'e', 0, "け" },
{ 20, 'i', 0, "き" },
{ 20, 'o', 0, "こ" },
{ 20, 'u', 0, "く" },
{ 20, 'w', 21, nil },
{ 20, 'y', 22, nil },
{ 20, 'k', 20, "っ" },
{ 23, 'a', 0, "ぁ" },
{ 23, 'e', 0, "ぇ" },
{ 23, 'i', 0, "ぃ" },
{ 23, 'k', 24, nil },
{ 23, 'o', 0, "ぉ" },
{ 23, 't', 25, nil },
{ 23, 'u', 0, "ぅ" },
{ 23, 'w', 27, nil },
{ 23, 'y', 28, nil },
{ 23, 'l', 23, "っ" },
{ 29, 'a', 0, "ま" },
{ 29, 'e', 0, "め" },
{ 29, 'i', 0, "み" },
{ 29, 'o', 0, "も" },
{ 29, 'u', 0, "む" },
{ 29, 'y', 30, nil },
{ 29, 'm', 29, "っ" },
{ 31, '\'', 0, "ん" },
{ 31, 'a', 0, "な" },
{ 31, 'e', 0, "ね" },
{ 31, 'i', 0, "に" },
{ 31, 'n', 0, "ん" },
{ 31, 'o', 0, "の" },
{ 31, 'u', 0, "ぬ" },
{ 31, 'y', 32, nil },
{ 33, 'a', 0, "ぱ" },
{ 33, 'e', 0, "ぺ" },
{ 33, 'i', 0, "ぴ" },
{ 33, 'o', 0, "ぽ" },
{ 33, 'u', 0, "ぷ" },
{ 33, 'y', 34, nil },
{ 33, 'p', 33, "っ" },
{ 35, 'a', 0, "くぁ" },
{ 35, 'e', 0, "くぇ" },
{ 35, 'i', 0, "くぃ" },
{ 35, 'o', 0, "くぉ" },
{ 35, 'u', 0, "く" },
{ 35, 'w', 36, nil },
{ 35, 'y', 37, nil },
{ 35, 'q', 35, "っ" },
{ 38, 'a', 0, "ら" },
{ 38, 'e', 0, "れ" },
{ 38, 'i', 0, "り" },
{ 38, 'o', 0, "ろ" },
{ 38, 'u', 0, "る" },
{ 38, 'y', 39, nil },
{ 38, 'r', 38, "っ" },
{ 40, 'a', 0, "さ" },
{ 40, 'e', 0, "せ" },
{ 40, 'h', 41, nil },
{ 40, 'i', 0, "し" },
{ 40, 'o', 0, "そ" },
{ 40, 'u', 0, "す" },
{ 40, 'w', 42, nil },
{ 40, 'y', 43, nil },
{ 40, 's', 40, "っ" },
{ 44, 'a', 0, "た" },
{ 44, 'e', 0, "て" },
{ 44, 'h', 45, nil },
{ 44, 'i', 0, "ち" },
{ 44, 'o', 0, "と" },
{ 44, 's', 46, nil },
{ 44, 'u', 0, "つ" },
{ 44, 'w', 47, nil },
{ 44, 'y', 48, nil },
{ 44, 't', 44, "っ" },
{ 49, 'a', 0, "ヴぁ" },
{ 49, 'e', 0, "ヴぇ" },
{ 49, 'i', 0, "ヴぃ" },
{ 49, 'o', 0, "ヴぉ" },
{ 49, 'u', 0, "ヴ" },
{ 49, 'y', 50, nil },
{ 49, 'v', 49, "っ" },
{ 51, 'a', 0, "わ" },
{ 51, 'e', 0, "うぇ" },
{ 51, 'h', 52, nil },
{ 51, 'i', 0, "うぃ" },
{ 51, 'o', 0, "を" },
{ 51, 'u', 0, "う" },
{ 51, 'w', 51, "っ" },
{ 53, 'a', 0, "ぁ" },
{ 53, 'e', 0, "ぇ" },
{ 53, 'i', 0, "ぃ" },
{ 53, 'k', 54, nil },
{ 53, 'n', 0, "ん" },
{ 53, 'o', 0, "ぉ" },
{ 53, 't', 55, nil },
{ 53, 'u', 0, "ぅ" },
{ 53, 'w', 56, nil },
{ 53, 'y', 57, nil },
{ 53, 'x', 53, "っ" },
{ 58, 'a', 0, "や" },
{ 58, 'e', 0, "いぇ" },
{ 58, 'i', 0, "い" },
{ 58, 'o', 0, "よ" },
{ 58, 'u', 0, "ゆ" },
{ 58, 'y', 58, "っ" },
{ 59, 'a', 0, "ざ" },
{ 59, 'e', 0, "ぜ" },
{ 59, 'i', 0, "じ" },
{ 59, 'o', 0, "ぞ" },
{ 59, 'u', 0, "ず" },
{ 59, 'y', 60, nil },
{ 59, 'z', 59, "っ" },
{ 2, 'a', 0, "びゃ" },
{ 2, 'e', 0, "びぇ" },
{ 2, 'i', 0, "びぃ" },
{ 2, 'o', 0, "びょ" },
{ 2, 'u', 0, "びゅ" },
{ 4, 'a', 0, "ちゃ" },
{ 4, 'e', 0, "ちぇ" },
{ 4, 'i', 0, "ち" },
{ 4, 'o', 0, "ちょ" },
{ 4, 'u', 0, "ちゅ" },
{ 5, 'a', 0, "ちゃ" },
{ 5, 'e', 0, "ちぇ" },
{ 5, 'i', 0, "ちぃ" },
{ 5, 'o', 0, "ちょ" },
{ 5, 'u', 0, "ちゅ" },
{ 7, 'a', 0, "でゃ" },
{ 7, 'e', 0, "でぇ" },
{ 7, 'i', 0, "でぃ" },
{ 7, 'o', 0, "でょ" },
{ 7, 'u', 0, "でゅ" },
{ 8, 'a', 0, "どぁ" },
{ 8, 'e', 0, "どぇ" },
{ 8, 'i', 0, "どぃ" },
{ 8, 'o', 0, "どぉ" },
{ 8, 'u', 0, "どぅ" },
{ 9, 'a', 0, "ぢゃ" },
{ 9, 'e', 0, "ぢぇ" },
{ 9, 'i', 0, "ぢぃ" },
{ 9, 'o', 0, "ぢょ" },
{ 9, 'u', 0, "ぢゅ" },
{ 11, 'a', 0, "ふぁ" },
{ 11, 'e', 0, "ふぇ" },
{ 11, 'i', 0, "ふぃ" },
{ 11, 'o', 0, "ふぉ" },
{ 11, 'u', 0, "ふぅ" },
{ 12, 'a', 0, "ふゃ" },
{ 12, 'e', 0, "ふぇ" },
{ 12, 'i', 0, "ふぃ" },
{ 12, 'o', 0, "ふょ" },
{ 12, 'u', 0, "ふゅ" },
{ 14, 'a', 0, "ぐぁ" },
{ 14, 'e', 0, "ぐぇ" },
{ 14, 'i', 0, "ぐぃ" },
{ 14, 'o', 0, "ぐぉ" },
{ 14, 'u', 0, "ぐぅ" },
{ 15, 'a', 0, "ぎゃ" },
{ 15, 'e', 0, "ぎぇ" },
{ 15, 'i', 0, "ぎぃ" },
{ 15, 'o', 0, "ぎょ" },
{ 15, 'u', 0, "ぎゅ" },
{ 17, 'a', 0, "ひゃ" },
{ 17, 'e', 0, "ひぇ" },
{ 17, 'i', 0, "ひぃ" },
{ 17, 'o', 0, "ひょ" },
{ 17, 'u', 0, "ひゅ" },
{ 19, 'a', 0, "じゃ" },
{ 19, 'e', 0, "じぇ" },
{ 19, 'i', 0, "じぃ" },
{ 19, 'o', 0, "じょ" },
{ 19, 'u', 0, "じゅ" },
{ 21, 'a', 0, "くぁ" },
{ 22, 'a', 0, "きゃ" },
{ 22, 'e', 0, "きぇ" },
{ 22, 'i', 0, "きぃ" },
{ 22, 'o', 0, "きょ" },
{ 22, 'u', 0, "きゅ" },
{ 24, 'a', 0, "ヵ" },
{ 24, 'e', 0, "ヶ" },
{ 25, 's', 26, nil },
{ 25, 'u', 0, "っ" },
{ 27, 'a', 0, "ゎ" },
{ 28, 'a', 0, "ゃ" },
{ 28, 'e', 0, "ぇ" },
{ 28, 'i', 0, "ぃ" },
{ 28, 'o', 0, "ょ" },
{ 28, 'u', 0, "ゅ" },
{ 30, 'a', 0, "みゃ" },
{ 30, 'e', 0, "みぇ" },
{ 30, 'i', 0, "みぃ" },
{ 30, 'o', 0, "みょ" },
{ 30, 'u', 0, "みゅ" },
{ 32, 'a', 0, "にゃ" },
{ 32, 'e', 0, "にぇ" },
{ 32, 'i', 0, "にぃ" },
{ 32, 'o', 0, "にょ" },
{ 32, 'u', 0, "にゅ" },
{ 34, 'a', 0, "ぴゃ" },
{ 34, 'e', 0, "ぴぇ" },
{ 34, 'i', 0, "ぴぃ" },
{ 34, 'o', 0, "ぴょ" },
{ 34, 'u', 0, "ぴゅ" },
{ 36, 'a', 0, "くぁ" },
{ 36, 'e', 0, "くぇ" },
{ 36, 'i', 0, "くぃ" },
{ 36, 'o', 0, "くぉ" },
{ 36, 'u', 0, "くぅ" },
{ 37, 'a', 0, "くゃ" },
{ 37, 'e', 0, "くぇ" },
{ 37, 'i', 0, "くぃ" },
{ 37, 'o', 0, "くょ" },
{ 37, 'u', 0, "くゅ" },
{ 39, 'a', 0, "りゃ" },
{ 39, 'e', 0, "りぇ" },
{ 39, 'i', 0, "りぃ" },
{ 39, 'o', 0, "りょ" },
{ 39, 'u', 0, "りゅ" },
{ 41, 'a', 0, "しゃ" },
{ 41, 'e', 0, "しぇ" },
{ 41, 'i', 0, "し" },
{ 41, 'o', 0, "しょ" },
{ 41, 'u', 0, "しゅ" },
{ 42, 'a', 0, "すぁ" },
{ 42, 'e', 0, "すぇ" },
{ 42, 'i', 0, "すぃ" },
{ 42, 'o', 0, "すぉ" },
{ 42, 'u', 0, "すぅ" },
{ 43, 'a', 0, "しゃ" },
{ 43, 'e', 0, "しぇ" },
{ 43, 'i', 0, "しぃ" },
{ 43, 'o', 0, "しょ" },
{ 43, 'u', 0, "しゅ" },
{ 45, 'a', 0, "てゃ" },
{ 45, 'e', 0, "てぇ" },
{ 45, 'i', 0, "てぃ" },
{ 45, 'o', 0, "てょ" },
{ 45, 'u', 0, "てゅ" },
{ 46, 'a', 0, "つぁ" },
{ 46, 'e', 0, "つぇ" },
{ 46, 'i', 0, "つぃ" },
{ 46, 'o', 0, "つぉ" },
{ 46, 'u', 0, "つ" },
{ 47, 'a', 0, "とぁ" },
{ 47, 'e', 0, "とぇ" },
{ 47, 'i', 0, "とぃ" },
{ 47, 'o', 0, "とぉ" },
{ 47, 'u', 0, "とぅ" },
{ 48, 'a', 0, "ちゃ" },
{ 48, 'e', 0, "ちぇ" },
{ 48, 'i', 0, "ちぃ" },
{ 48, 'o', 0, "ちょ" },
{ 48, 'u', 0, "ちゅ" },
{ 50, 'a', 0, "ヴゃ" },
{ 50, 'e', 0, "ヴぇ" },
{ 50, 'i', 0, "ヴぃ" },
{ 50, 'o', 0, "ヴょ" },
{ 50, 'u', 0, "ヴゅ" },
{ 52, 'a', 0, "うぁ" },
{ 52, 'e', 0, "うぇ" },
{ 52, 'i', 0, "うぃ" },
{ 52, 'o', 0, "うぉ" },
{ 52, 'u', 0, "う" },
{ 54, 'a', 0, "ヵ" },
{ 54, 'e', 0, "ヶ" },
{ 55, 'u', 0, "っ" },
{ 56, 'a', 0, "ゎ" },
{ 57, 'a', 0, "ゃ" },
{ 57, 'e', 0, "ぇ" },
{ 57, 'i', 0, "ぃ" },
{ 57, 'o', 0, "ょ" },
{ 57, 'u', 0, "ゅ" },
{ 60, 'a', 0, "じゃ" },
{ 60, 'e', 0, "じぇ" },
{ 60, 'i', 0, "じぃ" },
{ 60, 'o', 0, "じょ" },
{ 60, 'u', 0, "じゅ" },
{ 26, 'u', 0, "っ" },
}

function hiragana (s)
  local str = ""
  local state = 0
  s:gsub(".", function (c)
    local fsm = (fsm_hr[state][c] or fsm_hr[state][-1])
    if debug == nil then
      if fsm then
        if fsm.action then
          str = str .. fsm.action
        end
      else
        str = str .. c
      end
      state = fsm and fsm.new or 0
    else
      if fsm == nil then
        str = str .. "Error: State[" .. state .. "] Char[" .. c .. "]\n"
        return str
      end
      str = str .. "S[" .. state .. "]" .. " C[" .. c .. "] " .. dump(fsm) .. "\n"
      str = str .. "R: " .. (fsm.action or "") .. "\n"
      state = fsm.new
    end
  end)
  return str
end

-- ime.register_command("kt", "katakana", "片仮名", "none")
ime.register_command("hr", "hiragana", "平仮名", "none")
